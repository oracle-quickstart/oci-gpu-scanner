apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-clusterissuer-setup
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "corrino-lens.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "1"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "corrino-lens.serviceAccountName" . }}
      containers:
      - name: clusterissuer-setup
        image: docker.io/alpine/k8s:1.31.10
        command:
        - /bin/bash
        - -c
        - |
          echo "Waiting for cert-manager to be ready..."
          
          {{- if index .Values "cert-manager" "enabled" }}
          # Clean up any old conflicting webhook configurations (only when installing cert-manager)
          echo "Checking for old webhook configurations..."
          if kubectl get mutatingwebhookconfiguration cert-manager-webhook >/dev/null 2>&1; then
            OLD_NS=$(kubectl get mutatingwebhookconfiguration cert-manager-webhook -o jsonpath='{.webhooks[0].clientConfig.service.namespace}')
            if [ "$OLD_NS" != "{{ .Release.Namespace }}" ]; then
              echo "Found old webhook pointing to namespace: $OLD_NS, removing..."
              kubectl delete mutatingwebhookconfiguration cert-manager-webhook --ignore-not-found=true
              kubectl delete validatingwebhookconfiguration cert-manager-webhook --ignore-not-found=true
              echo "Old webhooks removed"
            fi
          fi
          {{- else }}
          echo "Using existing cert-manager installation (cert-manager.enabled=false)"
          {{- end }}
          
          # First check if the ClusterIssuer already exists and is Ready
          echo "Checking if ClusterIssuer '{{ .Values.ingress.certManager.clusterIssuer }}' already exists..."
          EXISTING_STATUS=$(kubectl get clusterissuer {{ .Values.ingress.certManager.clusterIssuer }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "NotFound")
          
          if [ "$EXISTING_STATUS" = "True" ]; then
            echo "ClusterIssuer '{{ .Values.ingress.certManager.clusterIssuer }}' already exists and is Ready!"
            echo "Skipping ClusterIssuer creation."
            exit 0
          elif [ "$EXISTING_STATUS" != "NotFound" ]; then
            echo "ClusterIssuer '{{ .Values.ingress.certManager.clusterIssuer }}' exists but status is: $EXISTING_STATUS"
            echo "Will wait for it to become ready..."
            for i in {1..30}; do
              STATUS=$(kubectl get clusterissuer {{ .Values.ingress.certManager.clusterIssuer }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "Unknown")
              if [ "$STATUS" = "True" ]; then
                echo "ClusterIssuer is now Ready!"
                exit 0
              fi
              echo "Waiting for ClusterIssuer to be ready... (attempt $i/30, status: $STATUS)"
              sleep 5
            done
            echo "ClusterIssuer exists but did not become ready in time. Continuing anyway."
            exit 0
          fi
          
          echo "ClusterIssuer '{{ .Values.ingress.certManager.clusterIssuer }}' not found. Will create it."
          
          # Wait for cert-manager to be ready by checking if API resources are available
          for i in {1..60}; do
            # Check if cert-manager API resources are available
            if kubectl api-resources | grep -q "clusterissuers.*cert-manager.io"; then
              echo "Cert-manager API resources found, testing if it's ready..."
              
              # Try to create a test ClusterIssuer to verify cert-manager is working
              kubectl apply -f - <<EOF >/dev/null 2>&1
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: {{ .Values.ingress.certManager.clusterIssuer }}-test
          spec:
            acme:
              server: https://acme-staging-v02.api.letsencrypt.org/directory
              email: {{ .Values.ingress.certManager.email }}
              privateKeySecretRef:
                name: test-key
              solvers:
              - http01:
                  ingress:
                    ingressClassName: {{ .Values.ingress.className }}
          EOF
              
              if [ $? -eq 0 ]; then
                kubectl delete clusterissuer {{ .Values.ingress.certManager.clusterIssuer }}-test >/dev/null 2>&1 || true
                echo "Cert-manager is ready!"
                break
              fi
            fi
            echo "Waiting for cert-manager to be ready... (attempt $i/60)"
            sleep 5
          done
          
          echo "Creating or updating ClusterIssuer..."
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: {{ .Values.ingress.certManager.clusterIssuer }}
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: {{ .Values.ingress.certManager.email }}
              privateKeySecretRef:
                name: {{ .Values.ingress.certManager.clusterIssuer }}-private-key
              solvers:
              - http01:
                  ingress:
                    ingressClassName: {{ .Values.ingress.className }}
          EOF
          
          if [ $? -eq 0 ]; then
            echo "ClusterIssuer created successfully!"
          else
            echo "Failed to create ClusterIssuer"
            exit 1
          fi