# Global configuration
global:
  namespace: oci-gpu-scanner-plugin
  pushGatewayUrl: "http://prometheus-pushgateway:9091/"
  ociImageRegistry: iad.ocir.io/iduyx1qnmway/lens-metric-collector

# Namespace configuration
namespace:
  create: false
  name: oci-gpu-scanner-plugin

# Go Plugin configuration
goPlugin:
  enabled: true
  image:
    repository: oci_lens_metric_collector
    tag: v0.0.9
    pullPolicy: Always
  
  config:
    gpuType: "amd"
    pushFrequency: "10"
    jobName: "oci_lens_node_metrics"
    maxPasses: "0"
    sleepSecs: "10"
    logLevel: "info"
    logFormat: "json"
  
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# AMD GPU Exporter
amdGpuExporter:
  enabled: true

device-metrics-exporter-charts:
  global:
    imageRegistry: ""
  platform: k8s
  nodeSelector:
    amd.com/gpu: "true"
  kubelet:
    podResourceAPISocketPath: /var/lib/kubelet/pod-resources
  image:
    repository: docker.io/rocm/device-metrics-exporter
    tag: v1.4.0
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    ClusterIP:
      port: 5000
  tolerations:
    - key: amd.com/gpu
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# NVIDIA GPU Exporter
nvidiaGpuExporter:
  enabled: true

# Configuration for DCGM Exporter subchart
dcgm-exporter:
  namespaceOverride: ""
  nodeSelector:
    nvidia.com/gpu: "true"
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
      nvidia.com/gpu: 1 
  serviceMonitor:
    enabled: false

# Metrics Push Job
metricsPushJob:
  enabled: true
  pushIntervalSeconds: 60 
  enableServiceDiscovery: false
  
  resources:
    requests:
      memory: "32Mi"
      cpu: "50m"
    limits:
      memory: "64Mi"
      cpu: "100m"

# Active Health Check
healthCheck:
  enabled: false
  image:
    repository: oci_lens_healthcheck_amd
    tag: v0.0.4
    pullPolicy: Always
  
  resources:
    requests:
      memory: "32Gi"
      cpu: "16"
      amd.com/gpu: 8
    limits:
      memory: "32Gi"
      cpu: "16"
      amd.com/gpu: 8

drhpc:
  enabled: true
  gpuTypes:
    - type: amd
      enabled: true
      image:
        repository: oci-dr-hpc-v2       
        rocmVersion: rocm                 # ROCm version prefix
        tag: latest                       # Tag comes after rocm version
        pullPolicy: Always
      resultsHostPath: "/var/lib/oci-dr-hpc-v2"
      nodeSelector:
        amd.com/gpu: "true"
      tolerations:
        - key: amd.com/gpu
          operator: Exists
          effect: NoSchedule
      resources: {}
      extraEnv: []
    
    - type: nvidia
      enabled: true
      image:
        repository: oci-dr-hpc-v2        
        cudaVersion: cuda-12.9.0          # CUDA version prefix
        tag: latest                       # Tag comes after cuda version
        pullPolicy: Always
      resultsHostPath: "/var/lib/oci-dr-hpc-v2"                        
      nodeSelector:
        nvidia.com/gpu: "true"
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      resources: {}
      extraEnv: []

# RBAC
rbac:
  create: true

# Node Exporter
nodeExporter:
  enabled: false
  
# Override default values for the official chart
prometheus-node-exporter:
  namespaceOverride: "" 
  image:
    registry: "quay.io"
    repository: prometheus/node-exporter
    tag: v1.8.2
    pullPolicy: IfNotPresent
  hostRootFsMount:
    enabled: true
  hostNetwork: true
  hostPID: true
  extraArgs:
    - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
    - --collector.filesystem.fs-types-exclude=^(sys|proc|auto)fs$$
    - --web.max-requests=40
    - --no-collector.systemd
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

# Pod Node Mapper
podNodeMapper:
  enabled: true
  replicas: 1
  image:
    repository: oci_lens_pod_node_info
    tag: latest
    pullPolicy: Always
  
  # Configuration
  jobName: "oci_lens_pod_metrics"
  clusterName: "oci-lens-cluster"  # Update this per cluster
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Node Problem Detector
nodeProblemDetector:
  enabled: false
  enableGpuChecks: true  # Enable GPU health checks via DRHPC
  
  # DRHPC results path - must match the hostPath where DRHPC writes results
  # Default is /var/lib/oci-dr-hpc-v2 which matches drhpc.resultsHostPath
  drhpcResultsPath: "/var/lib/oci-dr-hpc-v2"
  
  image:
    repository: phx.ocir.io/idnlixcmffxd/oke-public-node-problem-detector
    tag: v0.8.20.7
    sha256: sha256:399b506dbfa5c33e60a247d0d3199f025d242b7a7480c956446e70eaa090c599
    pullPolicy: Always
  
  prometheusPort: 20257
  
# Node Problem Detector
nodeProblemDetector:
  enabled: true
  enableGpuChecks: true
  namespace: kube-system
  
  # DRHPC results path - must match the hostPath where DRHPC writes results
  # Default is /var/lib/oci-dr-hpc-v2 which matches drhpc.resultsHostPath
  drhpcResultsPath: "/var/lib/oci-dr-hpc-v2"
  
  image:
    repository: phx.ocir.io/idnlixcmffxd/oke-public-node-problem-detector
    tag: v0.8.20.7
    sha256: sha256:399b506dbfa5c33e60a247d0d3199f025d242b7a7480c956446e70eaa090c599
    pullPolicy: Always
  
  prometheusPort: 20257
  
  # Node selector - defaults to OKE node-problem-detector label
  nodeSelector:
    oci.oraclecloud.com/oke-node-problem-detector-enabled: "true"
  
  # TolenableGpuCheckserations for GPU nodes
  tolerations:
    - key: CriticalAddonsOnly
      operator: Exists
    - key: oci.oraclecloud.com/oke-is-preemptible
      operator: Exists
    - effect: NoSchedule
      key: nvidia.com/gpu
      operator: Exists
    - effect: NoSchedule
      key: amd.com/gpu
      operator: Exists
    - effect: NoSchedule
      key: oci.oraclecloud.com/node-auto-repair-scheduled
      operator: Exists
  
  resources:
    requests:
      cpu: 10m
      memory: 80Mi
    limits:
      cpu: 10m
      memory: 80Mi